<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Umpire Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom High Contrast & Animation Styles */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            touch-action: manipulation;
            /* Improves touch response */
        }

        .btn-tap {
            transition: transform 0.05s ease, opacity 0.1s;
        }

        .btn-tap:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        /* Free Hit Pulse Animation */
        @keyframes pulse-gold {

            0%,
            100% {
                box-shadow: 0 0 0 0px rgba(255, 215, 0, 0.7);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(255, 215, 0, 0);
            }
        }

        .free-hit-active {
            background-color: #FCD34D !important;
            /* amber-300 */
            color: #000 !important;
            animation: pulse-gold 2s infinite;
        }

        .free-hit-text {
            display: none;
        }

        .free-hit-mode .free-hit-text {
            display: block;
        }

        /* Dot Ball Styles */
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #cbd5e1;
            /* slate-300 */
            margin: 2px;
            transition: all 0.2s;
        }

        .dot.active {
            background-color: #334155;
            /* slate-700 */
        }

        .dot.wicket {
            background-color: #ef4444;
            /* red-500 */
        }

        .dot.extra {
            background-color: #f59e0b;
            /* amber-500 */
        }

        .dot.boundary {
            background-color: #3b82f6;
            /* blue-500 */
        }

        .dot.six {
            background-color: #22c55e;
            /* green-500 */
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col overflow-x-hidden overflow-y-auto select-none">

    <!-- Header / Scoreboard -->
    <header id="scoreboard"
        class="flex-none p-4 bg-slate-800 border-b border-slate-700 relative transition-colors duration-300">
        <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none overflow-hidden">
            <span id="free-hit-bg-text" class="text-6xl font-black uppercase tracking-tighter hidden">FREE HIT</span>
        </div>

        <div class="flex justify-between items-start mb-2">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider" id="match-format-text">Match (8
                Overs)</div>
            <button onclick="app.undo()"
                class="px-4 py-2 bg-slate-700 rounded text-slate-200 font-bold btn-tap text-sm flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
                UNDO
            </button>
        </div>

        <div class="text-center">
            <div class="text-7xl font-bold tracking-tight leading-none" id="score-display">0/0</div>
            <div class="text-2xl font-semibold text-slate-400 mt-1" id="overs-display">0.0 Overs</div>
            <div class="text-sm font-bold text-amber-400 mt-1 hidden" id="free-hit-banner">‚ö†Ô∏è FREE HIT ACTIVE ‚ö†Ô∏è</div>
        </div>

        <!-- Over Tracker -->
        <div class="mt-4 flex justify-center items-center gap-1 h-4" id="over-tracker">
            <!-- Dots generated by JS -->
        </div>

        <!-- Target Mode Info -->
        <div id="target-info" class="mt-2 text-center hidden">
            <div class="text-sm text-slate-300 flex justify-center gap-4">
                <span class="font-bold">Need: <span id="runs-needed" class="text-white">--</span></span>
                <span class="font-bold">RRR: <span id="rrr-display" class="text-white">--</span></span>
            </div>
        </div>
    </header>

    <!-- Main Action Grid -->
    <div class="flex-1 p-2 grid grid-cols-3 gap-2 pb-safe">
        <!-- Runs Row 1 -->
        <button onclick="app.score(0)"
            class="btn-tap bg-slate-700 rounded-xl text-3xl font-bold flex items-center justify-center">0</button>
        <button onclick="app.score(1)"
            class="btn-tap bg-slate-700 rounded-xl text-3xl font-bold flex items-center justify-center">1</button>
        <button onclick="app.score(2)"
            class="btn-tap bg-slate-700 rounded-xl text-3xl font-bold flex items-center justify-center">2</button>

        <!-- Runs Row 2 -->
        <button onclick="app.score(3)"
            class="btn-tap bg-slate-700 rounded-xl text-3xl font-bold flex items-center justify-center">3</button>
        <button onclick="app.score(4)"
            class="btn-tap bg-blue-600 rounded-xl text-3xl font-bold flex items-center justify-center text-white">4</button>
        <button onclick="app.score(6)"
            class="btn-tap bg-green-600 rounded-xl text-3xl font-bold flex items-center justify-center text-white">6</button>

        <!-- Extras Row -->
        <button onclick="app.extra('WD')"
            class="btn-tap bg-slate-600 rounded-xl text-2xl font-bold flex flex-col items-center justify-center text-amber-300">
            <span>WD</span>
            <span class="text-xs text-slate-300 font-normal">+1 Run</span>
        </button>
        <button onclick="app.extra('NB')"
            class="btn-tap bg-slate-600 rounded-xl text-2xl font-bold flex flex-col items-center justify-center text-amber-300">
            <span>NB</span>
            <span class="text-xs text-slate-300 font-normal">+1 & Free Hit</span>
        </button>
        <button onclick="app.wicket()" id="btn-wicket"
            class="btn-tap bg-red-600 rounded-xl text-2xl font-bold flex flex-col items-center justify-center text-white">
            <span>OUT</span>
            <span class="text-xs text-red-200 font-normal">Wicket</span>
        </button>
    </div>

    <!-- Footer Controls -->
    <div class="flex-none p-4 grid grid-cols-3 gap-2 bg-slate-800 border-t border-slate-700">
        <button onclick="app.toggleTargetMode()"
            class="p-3 bg-slate-700 text-slate-200 rounded font-semibold text-xs btn-tap flex flex-col items-center gap-1">
            <span>üéØ</span> Target
        </button>
        <button onclick="app.toggleHistory()"
            class="p-3 bg-slate-700 text-slate-200 rounded font-semibold text-xs btn-tap flex flex-col items-center gap-1">
            <span>üìú</span> History
        </button>
        <button onclick="app.resetMatch()"
            class="p-3 bg-red-900/50 text-red-100 rounded font-semibold text-xs btn-tap flex flex-col items-center gap-1">
            <span>üóëÔ∏è</span> Reset
        </button>
    </div>

    <!-- Event History Modal -->
    <div id="history-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-end justify-center">
        <div
            class="bg-slate-800 w-full max-w-lg rounded-t-3xl shadow-2xl flex flex-col h-[70vh] border-t border-slate-600">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Innings Log</h3>
                <button onclick="app.toggleHistory()" class="p-2 text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Log entries here -->
            </div>
        </div>
    </div>

    <!-- Match End Modal -->
    <div id="match-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-slate-600">
            <h2 class="text-3xl font-bold mb-4">Innings Over</h2>
            <div class="text-6xl font-bold mb-6 text-white" id="modal-score">0/0</div>
            <p class="text-slate-400 mb-8" id="modal-msg">8 Overs Completed</p>
            <button onclick="app.closeModal()"
                class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg text-white">Close</button>
        </div>
    </div>

    <!-- Target Set Modal -->
    <div id="target-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center border border-slate-600">
            <h3 class="text-xl font-bold mb-4">Set Target Score</h3>
            <input type="number" id="target-input"
                class="w-full bg-slate-900 border border-slate-700 p-3 rounded text-xl text-center text-white mb-4"
                placeholder="Enter runs to win">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="app.cancelTarget()"
                    class="py-2 bg-slate-600 rounded font-semibold text-slate-200">Cancel</button>
                <button onclick="app.saveTarget()" class="py-2 bg-blue-600 rounded font-semibold text-white">Set
                    Target</button>
            </div>
        </div>
    </div>

    <!-- Match Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-slate-600">
            <h2 class="text-3xl font-bold mb-2">Match Setup</h2>
            <p class="text-slate-400 mb-6">Select number of overs for this match.</p>
            <div class="bg-slate-900 p-4 rounded-xl mb-6 border border-slate-700">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Overs per Innings</label>
                <input type="number" id="setup-overs" value="8"
                    class="w-full bg-transparent text-5xl font-bold text-center text-white focus:outline-none" min="1"
                    max="100">
            </div>
            <button onclick="app.startMatch()"
                class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold text-lg text-white btn-tap shadow-lg shadow-blue-900/50">Start
                Match</button>
        </div>
    </div>

    <script>
        class CricketApp {
            constructor() {
                this.historyStack = [];
                this.state = {
                    runs: 0,
                    wickets: 0,
                    balls: 0,
                    overs: 0,
                    ballsInOver: 0,
                    currentOverHistory: [],
                    eventLog: [], // [{msg, over, score, time}]
                    isFreeHit: false,
                    target: null,
                    maxOvers: 8,
                    innings: 1, // 1 or 2
                    firstInningsScore: null,
                    matchStarted: false
                };

                this.loadState();
                this.initSetup();
                this.render();
            }

            vibrate() {
                if (navigator.vibrate) navigator.vibrate(50);
            }

            saveState() {
                localStorage.setItem('cricketState', JSON.stringify(this.state));
                localStorage.setItem('cricketHistory', JSON.stringify(this.historyStack));
            }

            loadState() {
                const savedState = localStorage.getItem('cricketState');
                const savedHistory = localStorage.getItem('cricketHistory');
                if (savedState) {
                    try {
                        const loadedState = JSON.parse(savedState);
                        // Merge defaults with loaded state to handle updates/new features safely
                        this.state = { ...this.state, ...loadedState };

                        // Ensure critical arrays are initialized if missing or corrupted
                        if (!Array.isArray(this.state.eventLog)) this.state.eventLog = [];
                        if (!Array.isArray(this.state.currentOverHistory)) this.state.currentOverHistory = [];
                    } catch (e) {
                        console.error("Failed to load state:", e);
                        // Fallback to default state if corrupted
                    }
                }
                if (savedHistory) {
                    try {
                        this.historyStack = JSON.parse(savedHistory);
                        if (!Array.isArray(this.historyStack)) this.historyStack = [];
                    } catch (e) {
                        this.historyStack = [];
                    }
                }
            }

            initSetup() {
                if (!this.state.matchStarted) {
                    document.getElementById('setup-modal').classList.remove('hidden');
                }
            }

            startMatch() {
                const oversInput = document.getElementById('setup-overs');
                const overs = parseInt(oversInput.value);
                if (overs > 0 && overs <= 100) {
                    this.state.maxOvers = overs;
                    this.state.matchStarted = true;
                    document.getElementById('setup-modal').classList.add('hidden');
                    this.saveState();
                    this.render();
                } else {
                    alert("Please enter a valid number of overs (1-100)");
                }
            }

            pushHistory() {
                if (this.historyStack.length >= 20) this.historyStack.shift();
                this.historyStack.push(JSON.parse(JSON.stringify(this.state)));
            }

            undo() {
                if (this.historyStack.length === 0) return;
                this.vibrate();
                this.state = this.historyStack.pop();
                this.saveState();
                this.render();
            }

            score(runs) {
                if (this.isMatchOver()) return;
                this.pushHistory();
                this.vibrate();

                this.state.runs += runs;
                this.addEvent(`${runs} Run${runs === 1 ? '' : 's'}`);
                this.handleLegalBall(runs);

                if (this.state.isFreeHit) this.state.isFreeHit = false;

                this.checkInningsStatus();
                this.saveState();
                this.render();
            }

            extra(type) {
                if (this.isMatchOver()) return;
                this.pushHistory();
                this.vibrate();

                if (type === 'WD' || type === 'NB') {
                    this.state.runs += 1;
                    this.state.currentOverHistory.push(type);
                    this.addEvent(type === 'WD' ? "Wide (+1)" : "No Ball (+1, Free Hit)");
                }

                if (type === 'NB') {
                    this.state.isFreeHit = true;
                }

                this.checkInningsStatus();
                this.saveState();
                this.render();
            }

            wicket() {
                if (this.isMatchOver()) return;
                if (this.state.isFreeHit) {
                    if (!confirm("Only Run-Outs allowed on Free Hit. Was this a Run-Out?")) return;
                }

                this.pushHistory();
                this.vibrate();

                this.state.wickets += 1;
                this.addEvent("WICKET!");
                this.handleLegalBall('W');

                if (this.state.isFreeHit) this.state.isFreeHit = false;

                this.checkInningsStatus();
                this.saveState();
                this.render();
            }


            handleLegalBall(outcome) {
                this.state.balls += 1;
                this.state.ballsInOver += 1;
                this.state.currentOverHistory.push(outcome);

                if (this.state.ballsInOver === 6) {
                    this.state.overs += 1;
                    this.state.ballsInOver = 0;
                    this.endOver();
                }
            }

            endOver() {
                setTimeout(() => {
                    if (this.state.ballsInOver === 0) {
                        this.state.currentOverHistory = [];
                        this.render();
                    }
                }, 1500);
            }

            addEvent(msg) {
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                this.state.eventLog.unshift({
                    msg,
                    over: `${this.state.overs}.${this.state.ballsInOver}`,
                    score: `${this.state.runs}/${this.state.wickets}`,
                    time
                });
            }

            toggleHistory() {
                const modal = document.getElementById('history-modal');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) {
                    this.renderHistory();
                }
            }

            renderHistory() {
                const container = document.getElementById('history-list');
                container.innerHTML = '';

                if (this.state.eventLog.length === 0) {
                    container.innerHTML = '<div class="text-slate-500 text-center py-8 italic">No events recorded yet</div>';
                    return;
                }

                this.state.eventLog.forEach(ev => {
                    const row = document.createElement('div');
                    row.className = 'bg-slate-700/50 p-3 rounded-xl flex justify-between items-center border border-slate-700';
                    row.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-400 font-bold uppercase tracking-tighter">${ev.time} ‚Ä¢ OVER ${ev.over}</span>
                            <span class="text-lg font-bold ${ev.msg.includes('WICKET') ? 'text-red-400' : ev.msg.includes('Run') ? 'text-white' : 'text-amber-400'}">${ev.msg}</span>
                        </div>
                        <div class="text-right">
                             <span class="text-xl font-black text-slate-300">${ev.score}</span>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }

            isMatchOver() {
                if (this.state.innings === 2 && this.state.target !== null && this.state.runs >= this.state.target) {
                    return true;
                }
                if (this.state.overs >= this.state.maxOvers || this.state.wickets >= 10) {
                    return true;
                }
                return false;
            }

            checkInningsStatus() {
                if (this.isMatchOver()) {
                    this.showInningsResult();
                }
            }

            showInningsResult() {
                const modal = document.getElementById('match-modal');
                const title = modal.querySelector('h2');
                const score = document.getElementById('modal-score');
                const msg = document.getElementById('modal-msg');
                const btn = modal.querySelector('button');

                score.innerText = `${this.state.runs}/${this.state.wickets}`;

                if (this.state.innings === 1) {
                    title.innerText = "Innings 1 Over";
                    const target = this.state.runs + 1;
                    msg.innerText = `Target for Innings 2: ${target}`;
                    btn.innerText = "Start 2nd Innings";
                    btn.onclick = () => this.startSecondInnings();
                } else {
                    title.innerText = "Match Completed";
                    if (this.state.runs >= this.state.target) {
                        msg.innerText = "Chasing Team WON!";
                    } else if (this.state.wickets >= 10 || this.state.overs >= this.state.maxOvers) {
                        if (this.state.runs === this.state.target - 1) msg.innerText = "Match TIED!";
                        else msg.innerText = "Defending Team WON!";
                    }
                    btn.innerText = "New Match";
                    btn.onclick = () => this.resetMatch();
                }
                modal.classList.remove('hidden');
            }

            startSecondInnings() {
                this.pushHistory();
                const target = this.state.runs + 1;
                this.state.firstInningsScore = this.state.runs;
                this.state.innings = 2;
                this.state.target = target;

                this.state.runs = 0;
                this.state.wickets = 0;
                this.state.balls = 0;
                this.state.overs = 0;
                this.state.ballsInOver = 0;
                this.state.currentOverHistory = [];
                this.state.eventLog = [];
                this.state.isFreeHit = false;

                document.getElementById('match-modal').classList.add('hidden');
                this.saveState();
                this.render();
            }

            closeModal() {
                document.getElementById('match-modal').classList.add('hidden');
            }

            resetMatch() {
                if (!confirm("Reset match completely? All data will be lost.")) return;
                this.state = {
                    runs: 0,
                    wickets: 0,
                    balls: 0,
                    overs: 0,
                    ballsInOver: 0,
                    currentOverHistory: [],
                    eventLog: [],
                    isFreeHit: false,
                    target: null,
                    maxOvers: 8,
                    innings: 1,
                    firstInningsScore: null,
                    matchStarted: false
                };
                this.historyStack = [];
                document.getElementById('match-modal').classList.add('hidden');
                this.saveState();
                this.initSetup();
                this.render();
            }

            toggleTargetMode() {
                if (this.state.innings === 2) {
                    alert("Target is locked for 2nd innings based on 1st innings score.");
                    return;
                }
                document.getElementById('target-modal').classList.remove('hidden');
                if (this.state.target) {
                    document.getElementById('target-input').value = this.state.target;
                }
            }

            cancelTarget() {
                document.getElementById('target-modal').classList.add('hidden');
            }

            saveTarget() {
                const val = parseInt(document.getElementById('target-input').value);
                this.state.target = isNaN(val) ? null : val;
                this.saveState();
                this.render();
                this.cancelTarget();
            }

            render() {
                document.getElementById('score-display').innerText = `${this.state.runs}/${this.state.wickets}`;
                document.getElementById('overs-display').innerText = `${this.state.overs}.${this.state.ballsInOver} Overs`;
                document.getElementById('match-format-text').innerText = `${this.state.maxOvers} Overs (${this.state.innings === 1 ? '1st' : '2nd'} Innings)`;

                const header = document.getElementById('scoreboard');
                const banner = document.getElementById('free-hit-banner');
                const textBg = document.getElementById('free-hit-bg-text');
                const wicketBtn = document.getElementById('btn-wicket');

                if (this.state.isFreeHit) {
                    header.classList.add('free-hit-active');
                    document.body.classList.add('free-hit-mode');
                    banner.classList.remove('hidden');
                    textBg.classList.remove('hidden');
                    wicketBtn.querySelector('span:first-child').innerText = "RUN OUT";
                    wicketBtn.classList.replace('bg-red-600', 'bg-orange-600');
                } else {
                    header.classList.remove('free-hit-active');
                    document.body.classList.remove('free-hit-mode');
                    banner.classList.add('hidden');
                    textBg.classList.add('hidden');
                    wicketBtn.querySelector('span:first-child').innerText = "OUT";
                    wicketBtn.classList.replace('bg-orange-600', 'bg-red-600');
                }

                const tracker = document.getElementById('over-tracker');
                tracker.innerHTML = '';
                this.state.currentOverHistory.forEach(ball => {
                    const dot = document.createElement('div');
                    dot.className = `dot active ${ball === 'W' ? 'wicket' : ball === '4' ? 'boundary' : ball === '6' ? 'six' : (ball === 'WD' || ball === 'NB') ? 'extra' : ''}`;
                    tracker.appendChild(dot);
                });

                const targetInfo = document.getElementById('target-info');
                if (this.state.target) {
                    targetInfo.classList.remove('hidden');
                    const needed = Math.max(0, this.state.target - this.state.runs);
                    document.getElementById('runs-needed').innerText = needed;
                    const ballsRem = (this.state.maxOvers * 6) - this.state.balls;
                    const rrr = ballsRem > 0 ? (needed / (ballsRem / 6)).toFixed(2) : '-';
                    document.getElementById('rrr-display').innerText = rrr;
                } else {
                    targetInfo.classList.add('hidden');
                }
            }
        }

        const app = new CricketApp();
    </script>
</body>

</html>